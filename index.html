<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Project Showcase Hub</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-super-hands/dist/aframe-super-hands.min.js"></script>
    <style>
        body { margin: 0; }
        a-scene { height: 100vh; width: 100vw; }
    </style>
</head>
<body>
<a-scene vr-mode-ui="enabled: true">

    <a-assets></a-assets>

    <a-entity 
        environment="preset: dream; ground: spikes; groundColor: #1a202c; groundColor2: #2d3748; skyColor: #1a202c; horizonColor: #4a5568; sunPosition: 0 1 -10">
    </a-entity>

    <a-entity id="cameraRig" position="0 1.6 0" 
              movement-controls="fly: false; speed: 0.1;">
        
        <a-camera look-controls>
            <a-cursor
                raycaster="objects: .clickable"
                cursor-visible="true"
                cursor-opacity="1"
                cursor-color="#FFFFFF"
                cursor-maxdist="10">
            </a-cursor>
        </a-camera>

    <a-entity hand-controls="hand: left" 
          vive-controls="hand: left" 
          oculus-touch-controls="hand: left" 
          windows-motion-controls="hand: left" 
          daydream-controls="hand: left" 
          valve-index-controls="hand: left"
          laser-controls="hand: left"
          raycaster="objects: .clickable; far: 30;"
          cursor="fuse: false"
          super-hands>
      <a-box class="ray-viz" position="0 0 -15" width="0.02" height="0.02" depth="30" material="color:#ff4444; opacity:0.45; shader: flat"></a-box>
    </a-entity>
                  
    <a-entity hand-controls="hand: right" 
          vive-controls="hand: right" 
          oculus-touch-controls="hand: right" 
          windows-motion-controls="hand: right" 
          daydream-controls="hand: right" 
          valve-index-controls="hand: right"
          laser-controls="hand: right"
          raycaster="objects: .clickable; far: 30;"
          cursor="fuse: false"
          super-hands>
      <a-box class="ray-viz" position="0 0 -15" width="0.02" height="0.02" depth="30" material="color:#44ff44; opacity:0.45; shader: flat"></a-box>
    </a-entity>
    </a-entity>

    <a-text 
        value="VR Showcase" 
        position="0 3 -4" 
        align="center" 
        width="8" 
        color="#FFFFFF">
    </a-text>
    <a-text 
        value="Look at a portal and click to enter an experience" 
        position="0 2.6 -4" 
        align="center" 
        width="5" 
        color="#d1d5db">
    </a-text>

    <a-entity id="glacier-portal" class="portal" position="-4 1.6 -4" scale="1 1 1">
        <a-cylinder color="#60a5fa" radius="1" height="0.2"></a-cylinder>
        <a-text value="Glacier Melt Visualization" align="center" position="0 1 0" width="5"></a-text>
    <a-plane class="clickable" width="2.5" height="2.5" position="0 0.5 0.1" material="opacity:0; transparent:true"></a-plane>
    </a-entity>

    <a-entity id="trash-portal" class="portal" position="0 1.6 -4.5" scale="1 1 1">
        <a-cylinder color="#4ade80" radius="1" height="0.2"></a-cylinder>
        <a-text value="Trash Segregation Game" align="center" position="0 1 0" width="5"></a-text>
    <a-plane class="clickable" width="2.5" height="2.5" position="0 0.5 0.1" material="opacity:0; transparent:true"></a-plane>
    </a-entity>

    <a-entity id="forest-portal" class="portal" position="4 1.6 -4" scale="1 1 1">
        <a-cylinder color="#facc15" radius="1" height="0.2"></a-cylinder>
        <a-text value="Deforestation & Re-growth" align="center" position="0 1 0" width="5"></a-text>
    <a-plane class="clickable" width="2.5" height="2.5" position="0 0.5 0.1" material="opacity:0; transparent:true"></a-plane>
    </a-entity>

</a-scene>
 
<script>
        // Explicit raycast fallback for VR controllers: dispatch click events on nearest `.clickable`.
        (function () {
                    AFRAME.registerComponent('explicit-raycast-on-trigger', {
                        init: function () {
                            const sceneEl = this.el;
                            const DEBUG = true;
                            sceneEl.addEventListener('loaded', () => {
                                const controllers = sceneEl.querySelectorAll('[laser-controls], [hand-controls]');
                                controllers.forEach(ctrl => {
                                    ctrl.addEventListener('triggerdown', () => {
                                        if (DEBUG) console.log('[explicit-raycast] triggerdown from', ctrl.id || ctrl);
                                        const clickableEls = Array.from(sceneEl.querySelectorAll('.clickable'));
                                        if (!clickableEls.length) {
                                            if (DEBUG) console.log('[explicit-raycast] no .clickable elements');
                                            return;
                                        }
                                        const objects = clickableEls.map(el => el.object3D).filter(Boolean);

                                        const origin = new THREE.Vector3();
                                        const dir = new THREE.Vector3(0, 0, -1);
                                        const quat = new THREE.Quaternion();
                                        ctrl.object3D.getWorldPosition(origin);
                                        ctrl.object3D.getWorldQuaternion(quat);
                                        dir.applyQuaternion(quat).normalize();

                                        if (DEBUG) console.log('[explicit-raycast] origin', origin.toArray(), 'dir', dir.toArray());

                                        const ray = new THREE.Raycaster(origin, dir);
                                        const intersects = ray.intersectObjects(objects, true);
                                        if (intersects.length === 0) {
                                            if (DEBUG) console.log('[explicit-raycast] no intersections');
                                            return;
                                        }

                                        const hit = intersects[0];
                                        if (DEBUG) console.log('[explicit-raycast] hit', hit);

                                        if (DEBUG) {
                                            const marker = document.createElement('a-sphere');
                                            marker.setAttribute('color', '#ff0000');
                                            marker.setAttribute('radius', '0.05');
                                            marker.setAttribute('position', `${hit.point.x} ${hit.point.y} ${hit.point.z}`);
                                            marker.setAttribute('material', 'shader: flat; opacity: 0.9');
                                            sceneEl.appendChild(marker);
                                            setTimeout(() => marker.remove(), 1000);
                                        }

                                        let el = hit.object.el;
                                        while (el && !el.classList.contains('clickable')) el = el.parentNode;
                                        if (el) el.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
                                    });
                                });
                            });
                        }
                    });

            document.querySelectorAll('a-scene').forEach(s => s.setAttribute('explicit-raycast-on-trigger', ''));
        })();

        document.addEventListener('DOMContentLoaded', () => {
        const cursor = document.querySelector('a-cursor');
        const glacierPortal = document.querySelector('#glacier-portal');
        const trashPortal = document.querySelector('#trash-portal');
        const forestPortal = document.querySelector('#forest-portal');

        glacierPortal.addEventListener('click', () => { window.location.href = './Glacier.html'; });
        trashPortal.addEventListener('click', () => { window.location.href = './Trash_Game.html'; });
        forestPortal.addEventListener('click', () => { window.location.href = './Forest_Environment.html'; });

        const portals = document.querySelectorAll('.portal');
        portals.forEach(portal => {
            const originalScale = portal.getAttribute('scale');
            portal.addEventListener('mouseenter', () => {
                portal.setAttribute('scale', '1.1 1.1 1.1');
                if (cursor) cursor.setAttribute('cursor', 'color', '#facc15');
            });
            portal.addEventListener('mouseleave', () => {
                portal.setAttribute('scale', originalScale);
                if (cursor) cursor.setAttribute('cursor', 'color', '#FFFFFF');
            });
        });
    });
</script>
</body>
</html>